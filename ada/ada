#!/bin/bash

# This script talks to the dCache API.
#
# Design: Natalie & Onno, SURFsara.
#
# Latest version is available at: https://github.com/sara-nl/SpiderScripts
#
# Changes:
# 2020-01-28 - Onno    - Created
#

usage() {
  cat <<-EOF
	ADA - Access dCache API.
	Usage: $0 [options...]
	Options are:
	  (todo)
	  --debug                - Show what's going on.

	Default values can be stored in /etc/ada.conf and ~/.ada.conf
	Their signature is not logged to prevent theft.

	Examples:
	  $0 ... (todo)

	EOF
  exit 1
}

# Set default values
api=
debug=false
path=

# Load defaults from configuration file if exists
declare -a configfiles=( /etc/ada.conf ~/.ada.conf )
for configfile in ${configfiles[@]} ; do
  if [ -f "$configfile" ] ; then
    $debug && echo "Loading $configfile"
    source "$configfile"
  fi
done


# Process command line arguments
while [ $# -gt 0 ] ; do
  case "$1" in
    --token )
      token="$2"
      shift ; shift
      ;;
    --tokenfile )
      tokenfile="$2"
      shift ; shift
      ;;
    --api )
      api="$2"
      shift ; shift
      ;;
    --whoami )
      command=whoami
      shift
      ;;
    --list )
      command=list
      path="$2"
      shift ; shift
      ;;
    --longlist )
      command=longlist
      path="$2"
      shift ; shift
      ;;
    --mkdir )
      command=mkdir
      path="$2"
      shift ; shift
      ;;
    --mv )
      command=mv
      path="$2"
      destination="$3"
      shift ; shift ; shift
      ;;
    --delete )
      command=delete
      path="$2"
      shift ; shift
      ;;
    --checksum )
      command=checksum
      if [ "$2" = "--from-file" ] ; then
       	pathlist=$(<"$3")
        shift ; shift ; shift
      else
        pathlist="$2"
        shift ; shift
      fi
      ;;
    --stage )
      command=stage
      if [ "$2" = "--from-file" ] ; then
        pathlist=$(<"$3")
       	shift ;	shift ;	shift
      else
        pathlist="$2"
        shift ; shift
      fi
      ;;
    --debug )
      debug=true
      shift 1
      ;;
    *)
      usage
      ;;
  esac
done

#
# Validate input
#

if [ -z "$token" ] ; then
  if [ -n "$tokenfile" ] ; then
    token=$(sed -n 's/^bearer_token *= *//p' "$tokenfile")
    if [ $(wc -l <<<"$token") -gt 1 ] ; then
      echo "ERROR: file '$tokenfile' contains multiple tokens."
      exit 1
    fi
    if [ -z "$token" ] ; then
      echo "ERROR: could not read token from tokenfile."
      exit 1
    fi
  else
    echo "ERROR: no token or tokenfile specified."
    exit 1
  fi
fi

case $command in
  list | longlist | mkdir | mv | delete )
    if [[ -z $path || $path =~ ^-- ]] ; then
      echo "ERROR: command $command requires a path."
      exit 1
    fi
    if [ "$command" = "mv" ] ; then 
      if [[ -z $destination || $destination =~ ^-- ]] ; then
        echo "ERROR: command $command requires a destination."
        exit 1
      fi
    fi
    ;;
esac

if [ -z "$api" ] ; then
  echo "ERROR: no API specified. Use --api <api> or specify a default API in one of the configuration files (${configfiles[@]})."
fi

#
# End of input validation
#



# Construct the authorization part of the curl command.
# It's an array for easier handling of quotes.
curl_authorization=( "-H" "Authorization: Bearer $token" )

curl_options_common=(
                      -H "accept: application/json"
                      --fail --silent --show-error
                    )
curl_options_post=(
                    -H "content-type: application/json"
                  )

case $command in
  whoami )
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           -X GET "$api/user"
    ) \
    | jq
    ;;
  list )
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           -X GET "$api/namespace/$path?children=true&locality=false&locations=false&qos=false"
    ) \
    | jq -r '.children | .[] | [ .fileName , .fileType ] | @tsv' \
    | sed -e 's@\tREGULAR@@' \
          -e 's@\tDIR@/@' \
    | sort
    ;;
  longlist )
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           -X GET "$api/namespace/$path?children=true&locality=true&locations=false&qos=true"
    ) \
    | jq -r '.children | .[] | [ .fileName , .fileType , .size , (.mtime / 1000 | strftime("%Y-%m-%d %H:%M UTC")) , .fileLocality ] | @tsv' \
    | sed -e 's@\tREGULAR@@' \
          -e 's@\tDIR@/@' \
    | column -t -s $'\t' \
    | sort
    # Note: it would be better to use strflocaltime instead of strftime,
    # but that requires a newer version of jq than Centos 7 has.
    ;;
  mkdir )
    parent=$(dirname "$path")
    name=$(basename "$path")
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           "${curl_options_post[@]}" \
           -X POST "$api/namespace/$parent" \
           -d "{ \"action\":\"mkdir\";\"name\":\"$name\"}"
    ) \
    | jq -r .status
    ;;
  mv )
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           "${curl_options_post[@]}" \
           -X POST "$api/namespace/$path" \
           -d "{ \"action\":\"mv\";\"destination\":\"$destination\"}"
    ) \
    | jq -r .status
    ;;
  delete )
    (
      $debug && set -x   # If --debug is specified, show (only) curl command
      curl "${curl_authorization[@]}" \
           "${curl_options_common[@]}" \
           -X DELETE "$api/namespace/$path"
    ) \
    | jq -r .status
    ;;
  * )
    echo "Command $command is not implemented (yet)."
    ;;
esac
